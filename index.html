<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®Ÿç¿’æ—¥èªŒã‚·ã‚¹ãƒ†ãƒ  - æ§˜å¼8æº–æ‹ </title>
    <style>
        :root {
            --primary-color: #0056b3;
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --border-radius: 12px;
        }

        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 10px;
            color: #333;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        /* ã‚«ãƒ¼ãƒ‰ãƒ»ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .card {
            background: var(--card-bg);
            padding: 20px;
            margin-bottom: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        h2 {
            font-size: 1.25rem;
            color: var(--primary-color);
            border-left: 5px solid var(--primary-color);
            padding-left: 10px;
            margin-bottom: 20px;
        }

        /* å…¥åŠ›è¦ç´  */
        .form-control {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            background: #fff;
        }

        textarea.form-control {
            min-height: 120px;
            line-height: 1.6;
        }

        .reflection-area {
            min-height: 400px;
        }

        /* ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆPCç”¨ï¼‰ */
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        /* ãƒœã‚¿ãƒ³ */
        .btn {
            padding: 15px 20px;
            border-radius: 8px;
            border: none;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            transition: 0.2s;
            text-align: center;
        }

        .btn-primary { background: var(--primary-color); color: white; width: 100%; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-primary:hover { opacity: 0.9; }

        /* æ´»å‹•è¨˜éŒ²ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–åŒ– */
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: left; }
        th { background: #f8f9fa; font-size: 14px; }

        /* ã‚¹ãƒãƒ›å‘ã‘ã®èª¿æ•´ (768pxä»¥ä¸‹) */
        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; } /* 2ã‚«ãƒ©ãƒ ã‚’1ã‚«ãƒ©ãƒ ã« */
            .card { padding: 15px; }
            h2 { font-size: 1.1rem; }
            
            /* ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã•ã›ã‚‹ãŸã‚ã®æ¡ˆå†… */
            .table-wrapper::after {
                content: "â† æ¨ªã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ãã¾ã™ â†’";
                display: block;
                text-align: center;
                font-size: 12px;
                color: #999;
                margin-top: 5px;
            }
            .btn { font-size: 15px; padding: 12px; }
        }

        /* å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ */
        .hidden { display: none; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .mt-10 { margin-top: 10px; }
        
        #dateList { max-height: 300px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; }
        .date-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .date-item:hover { background: #f0f7ff; }
    </style>
</head>
<body>

<div class="container">
    <div id="loginScreen" class="card" style="max-width: 400px; margin: 50px auto;">
        <h2 style="border:none; text-align:center;">å­¦ç”Ÿãƒ­ã‚°ã‚¤ãƒ³</h2>
        <div style="margin-bottom:15px;">
            <label>å­¦ç±ç•ªå·</label>
            <input type="text" id="studentId" class="form-control" placeholder="IDã‚’å…¥åŠ›">
        </div>
        <div style="margin-bottom:20px;">
            <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
            <input type="password" id="password" class="form-control" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
        </div>
        <button onclick="login()" class="btn btn-primary">ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>

    <div id="mainApp" class="hidden">
        <div class="flex-between card">
            <h1 style="font-size:1.2rem; margin:0;">å®Ÿç¿’æ—¥èªŒã‚·ã‚¹ãƒ†ãƒ </h1>
            <div style="font-size:0.9rem;">
                <span id="userNameDisp"></span> ã•ã‚“ <button onclick="location.reload()" style="font-size:12px; margin-left:10px;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <h2>æ–°è¦ä½œæˆ</h2>
                <input type="date" id="newDate" class="form-control">
                <button onclick="createNewEntry()" class="btn btn-primary mt-10">æ–°è¦ä½œæˆã‚’é–‹å§‹</button>
            </div>
            <div class="card">
                <h2>ä¿å­˜æ¸ˆã¿ã‹ã‚‰è¿½è¨˜</h2>
                <div id="dateList">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
        </div>

        <form id="journalForm" class="hidden">
            <div class="card">
                <h2>åŸºæœ¬æƒ…å ±</h2>
                <div class="grid">
                    <div>
                        <label>å®Ÿç¿’æ—¥ç›®</label>
                        <input type="number" id="practiceDay" class="form-control" required>
                    </div>
                    <div>
                        <label>å¹´æœˆæ—¥</label>
                        <input type="date" id="practiceDate" class="form-control" readonly style="background:#eee;">
                    </div>
                </div>
                <div class="grid mt-10">
                    <div>
                        <label>å‡ºå¸­æ™‚é–“</label>
                        <input type="time" id="attendanceTime" class="form-control">
                    </div>
                    <div>
                        <label>é€€å‡ºæ™‚é–“</label>
                        <input type="time" id="exitTime" class="form-control">
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>æœ¬æ—¥ã®å­¦ç¿’ç›®æ¨™</h2>
                <textarea id="learningGoals" class="form-control"></textarea>
            </div>

            <div class="card">
                <h2>æ´»å‹•è¨˜éŒ²</h2>
                <div class="table-wrapper">
                    <table id="activityTable">
                        <thead>
                            <tr>
                                <th style="width:220px;">æ™‚é–“</th>
                                <th style="width:180px;">æ—¥ç¨‹</th>
                                <th>è¡Œå‹•ï¼ˆå…·ä½“çš„ã«ï¼‰</th>
                                <th style="width:40px;">æ¶ˆ</th>
                            </tr>
                        </thead>
                        <tbody id="activityBody"></tbody>
                    </table>
                </div>
                <button type="button" onclick="addActivityRow()" class="btn btn-secondary mt-10" style="width:100%;">ï¼‹ è¡Œã‚’è¿½åŠ </button>
            </div>

            <div class="card">
                <h2>ä»Šæ—¥ä¸€æ—¥ã‚’æŒ¯ã‚Šè¿”ã£ã¦</h2>
                <textarea id="reflection" class="form-control reflection-area" placeholder="å­¦ã³ã€è€ƒãˆãŸã“ã¨ã€æ„Ÿã˜ãŸã“ã¨ã‚’è©³ç´°ã«è¨˜å…¥"></textarea>
            </div>

            <div class="card">
                <h2>æ˜æ—¥ã¸ã®èª²é¡Œ</h2>
                <textarea id="tomorrowTasks" class="form-control"></textarea>
            </div>

            <div class="card">
                <h2>å®Ÿç¿’æŒ‡å°è€…ã‹ã‚‰ã®ã‚³ãƒ¡ãƒ³ãƒˆ</h2>
                <textarea id="instructorComment" class="form-control"></textarea>
            </div>

            <div style="position: sticky; bottom: 10px; padding: 10px 0;">
                <button type="submit" id="saveBtn" class="btn btn-primary" style="font-size:1.2rem;">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜ãƒ»æ›´æ–°</button>
            </div>
        </form>
    </div>
</div>

<script>
    // â˜…GASã®URLã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxzIcQ-9ZVaCEmnquYPiEDmxOUZfN9Wxl_ReBh4qpyUMGqLpJ_q3kknG-9geQhXDETmYw/exec";
    let user = { id: "", name: "" };

    const val = (v) => (v === undefined || v === null || v === "") ? "" : v;

    async function login() {
        const studentId = document.getElementById('studentId').value;
        const password = document.getElementById('password').value;
        try {
            const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "login", studentId, password })});
            const result = await res.json();
            if (result.success) {
                user = { id: studentId, name: result.userName };
                document.getElementById('userNameDisp').innerText = result.userName;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                refreshDateList();
            } else { alert("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—"); }
        } catch(e) { alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼"); }
    }

    async function refreshDateList() {
        const listDiv = document.getElementById('dateList');
        const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "getList", studentId: user.id })});
        const result = await res.json();
        if (result.dates && result.dates.length > 0) {
            listDiv.innerHTML = result.dates.map(date => `<div class="date-item" onclick="loadSpecificDate('${date}')"><span>ğŸ“… ${date}</span> <b>ç·¨é›† ></b></div>`).join('');
        } else { listDiv.innerHTML = "<p style='padding:10px;'>å±¥æ­´ãªã—</p>"; }
    }

    function createNewEntry() {
        const date = document.getElementById('newDate').value;
        if(!date) return alert("æ—¥ä»˜ã‚’é¸ã‚“ã§ãã ã•ã„");
        document.getElementById('journalForm').reset();
        document.getElementById('practiceDate').value = date;
        document.getElementById('activityBody').innerHTML = "";
        addActivityRow();
        document.getElementById('journalForm').classList.remove('hidden');
        document.getElementById('journalForm').scrollIntoView({behavior: "smooth"});
    }

    async function loadSpecificDate(date) {
        const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "load", studentId: user.id, date })});
        const result = await res.json();
        if (result.success) {
            const d = result.data;
            document.getElementById('journalForm').classList.remove('hidden');
            document.getElementById('practiceDay').value = val(d[3]);
            document.getElementById('practiceDate').value = date;
            document.getElementById('attendanceTime').value = val(d[5]);
            document.getElementById('exitTime').value = val(d[6]);
            document.getElementById('learningGoals').value = val(d[7]);
            
            const body = document.getElementById('activityBody');
            body.innerHTML = "";
            try {
                const activities = JSON.parse(d[8]);
                if(activities.length > 0) {
                    activities.forEach(a => addActivityRow(val(a.start), val(a.end), val(a.schedule), val(a.action)));
                } else { addActivityRow(); }
            } catch(e) { addActivityRow(); }

            document.getElementById('reflection').value = val(d[9]);
            document.getElementById('tomorrowTasks').value = val(d[10]);
            document.getElementById('instructorComment').value = val(d[11]);
            document.getElementById('journalForm').scrollIntoView({behavior: "smooth"});
        }
    }

    function addActivityRow(start="", end="", schedule="", action="") {
        const rowId = Date.now() + Math.random();
        const row = `<tr id="row_${rowId}">
            <td><div style="display:flex; align-items:center; gap:5px;"><input type="time" class="act-start" value="${start}">ï½<input type="time" class="act-end" value="${end}"></div></td>
            <td><input type="text" class="form-control act-sched" value="${schedule}"></td>
            <td><textarea class="form-control act-action" style="min-height:50px;">${action}</textarea></td>
            <td><button type="button" onclick="document.getElementById('row_${rowId}').remove()" style="color:red; background:none; border:none; font-size:20px;">Ã—</button></td>
        </tr>`;
        document.getElementById('activityBody').insertAdjacentHTML('beforeend', row);
    }

    document.getElementById('journalForm').onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById('saveBtn');
        btn.innerText = "ä¿å­˜ä¸­...";
        btn.disabled = true;

        const activities = Array.from(document.querySelectorAll('#activityBody tr')).map(tr => ({
            start: tr.querySelector('.act-start').value,
            end: tr.querySelector('.act-end').value,
            schedule: tr.querySelector('.act-sched').value,
            action: tr.querySelector('.act-action').value
        }));

        const data = {
            action: "save",
            studentId: user.id,
            studentName: user.name,
            practiceDay: document.getElementById('practiceDay').value,
            practiceDate: document.getElementById('practiceDate').value,
            attendanceTime: document.getElementById('attendanceTime').value,
            exitTime: document.getElementById('exitTime').value,
            learningGoals: document.getElementById('learningGoals').value,
            activities: activities,
            reflection: document.getElementById('reflection').value,
            tomorrowTasks: document.getElementById('tomorrowTasks').value,
            instructorComment: document.getElementById('instructorComment').value
        };

        try {
            await fetch(GAS_URL, { method: "POST", body: JSON.stringify(data) });
            alert("ä¿å­˜ã—ã¾ã—ãŸã€‚");
            refreshDateList();
        } catch (err) { alert("ä¿å­˜å¤±æ•—"); }
        finally { btn.innerText = "ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜ãƒ»æ›´æ–°"; btn.disabled = false; }
    };
</script>
</body>
</html>
