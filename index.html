<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®Ÿç¿’æ—¥èªŒã‚·ã‚¹ãƒ†ãƒ  - æ§˜å¼8æº–æ‹ </title>
    <style>
        :root {
            --primary-color: #0056b3;
            --success-color: #28a745;
            --bg-color: #f8f9fa;
            --card-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        body { font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", sans-serif; background: var(--bg-color); padding: 20px; color: #333; line-height: 1.6; }
        .container { max-width: 900px; margin: 0 auto; }
        .card { background: white; padding: 30px; margin-bottom: 25px; border-radius: 12px; box-shadow: var(--card-shadow); }
        h1, h2, h3 { color: var(--primary-color); border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 0; }
        
        /* å…¥åŠ›æ¬„ã®å¤§å‹åŒ–è¨­å®š */
        .form-control { width: 100%; padding: 15px; font-size: 16px; border: 1px solid #ced4da; border-radius: 8px; box-sizing: border-box; transition: border-color 0.2s; }
        .form-control:focus { border-color: var(--primary-color); outline: none; background: #fff; }
        textarea.form-control { min-height: 120px; resize: vertical; }
        .reflection-area { min-height: 450px !important; } /* æŒ¯ã‚Šè¿”ã‚Šæ¬„ã‚’æœ€å¤§åŒ– */
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .btn { padding: 15px 25px; cursor: pointer; border-radius: 8px; border: none; font-weight: bold; font-size: 16px; transition: all 0.2s; display: inline-block; text-align: center; }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-secondary { background: #6c757d; color: white; margin-top: 10px; }
        
        /* ãƒªã‚¹ãƒˆè¡¨ç¤º */
        #dateList { max-height: 250px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; margin-top: 10px; }
        .date-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .date-item:hover { background: #e9ecef; }
        .date-item b { color: var(--primary-color); }

        /* æ´»å‹•è¨˜éŒ²ãƒ†ãƒ¼ãƒ–ãƒ« */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #dee2e6; padding: 12px; vertical-align: top; }
        th { background: #f1f3f5; font-size: 14px; text-align: center; }
        .time-select-group { display: flex; align-items: center; gap: 5px; }
        .time-select-group input[type="time"] { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        
        .hidden { display: none; }
        .error { color: #dc3545; font-weight: bold; margin-bottom: 15px; }
        header { margin-bottom: 30px; text-align: center; }
    </style>
</head>
<body>

<div class="container">
    <div id="loginScreen" class="card" style="max-width: 450px; margin: 80px auto;">
        <h2 style="text-align:center">å®Ÿç¿’ç”Ÿãƒ­ã‚°ã‚¤ãƒ³</h2>
        <div id="loginError" class="error hidden">IDã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“</div>
        <div style="margin-bottom:15px;">
            <label>å­¦ç±ç•ªå·</label>
            <input type="text" id="studentId" class="form-control" placeholder="ä¾‹: 2024001">
        </div>
        <div style="margin-bottom:20px;">
            <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
            <input type="password" id="password" class="form-control" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
        </div>
        <button onclick="login()" class="btn btn-primary" style="width:100%">ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>

    <div id="mainApp" class="hidden">
        <header>
            <h1>å®Ÿç¿’æ—¥èªŒç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
            <p><span id="userNameDisp" style="font-weight:bold; font-size:1.2em;"></span> ã•ã‚“ã€ãŠç–²ã‚Œæ§˜ã§ã™ã€‚ | <a href="#" onclick="location.reload()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a></p>
        </header>

        <div class="grid">
            <div class="card">
                <h3>æ–°è¦ä½œæˆ </h3>
                <p>æ–°ã—ã„æ—¥ä»˜ã®æ—¥èªŒã‚’ä½œæˆã—ã¾ã™ã€‚</p>
                <input type="date" id="newDate" class="form-control">
                <button onclick="createNewEntry()" class="btn btn-primary" style="width:100%; margin-top:15px;">æ–°è¦æ—¥èªŒã‚’ä½œæˆ</button>
            </div>

            <div class="card">
                <h3>ä¿å­˜æ¸ˆã¿ã‹ã‚‰è¿½è¨˜ </h3>
                <p>éå»ã®è¨˜éŒ²ã‚’é¸æŠã—ã¦ä¿®æ­£ãƒ»è¿½è¨˜ã—ã¾ã™ã€‚</p>
                <div id="dateList">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
        </div>

        <form id="journalForm" class="hidden">
            <div class="card">
                <h2>åŸºæœ¬æƒ…å ± </h2>
                <div class="grid">
                    <div>
                        <label>å®Ÿç¿’æ—¥ç›®</label>
                        <input type="number" id="practiceDay" class="form-control" required placeholder="ä¾‹: 1">
                    </div>
                    <div>
                        <label>å¹´æœˆæ—¥</label>
                        <input type="date" id="practiceDate" class="form-control" readonly style="background:#f1f3f5;">
                    </div>
                </div>
                <div class="grid" style="margin-top:20px;">
                    <div>
                        <label>å‡ºå¸­æ™‚é–“</label>
                        <input type="time" id="attendanceTime" class="form-control">
                    </div>
                    <div>
                        <label>é€€å‡ºæ™‚é–“</label>
                        <input type="time" id="exitTime" class="form-control">
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>æœ¬æ—¥ã®å­¦ç¿’ç›®æ¨™ </h2>
                <textarea id="learningGoals" class="form-control" placeholder="ä»Šæ—¥ã®å®Ÿç¿’ã§å­¦ã³ãŸã„ã“ã¨ã€é”æˆã—ãŸã„ç›®æ¨™ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„"></textarea>
            </div>

            <div class="card">
                <h2>æ´»å‹•è¨˜éŒ² </h2>
                <table id="activityTable">
                    <thead>
                        <tr>
                            <th style="width: 260px;">æ™‚é–“</th>
                            <th style="width: 200px;">æ—¥ç¨‹</th>
                            <th>è¡Œå‹•ï¼ˆå…·ä½“çš„ã«è¨˜è¿°ã™ã‚‹ã“ã¨ï¼‰</th>
                            <th style="width: 40px;">æ¶ˆ</th>
                        </tr>
                    </thead>
                    <tbody id="activityBody"></tbody>
                </table>
                <button type="button" onclick="addActivityRow()" class="btn btn-secondary">ï¼‹ è¡Œã‚’è¿½åŠ </button>
            </div>

            <div class="card">
                <h2>ä»Šæ—¥ä¸€æ—¥ã‚’æŒ¯ã‚Šè¿”ã£ã¦ [cite: 5]</h2>
                <p style="font-size: 13px; color: #666; margin-top: -10px;">ï¼ˆå°è±¡ã«æ®‹ã£ãŸå­¦ã³ã€ãã‚Œã‚’é€šã—ã¦è€ƒãˆãŸã“ã¨ã€æ„Ÿã˜ãŸã“ã¨ï¼‰</p>
                <textarea id="reflection" class="form-control reflection-area" placeholder="å…·ä½“çš„ãªå ´é¢ã¨å…±ã«è©³ã—ãè¨˜å…¥ã—ã¦ãã ã•ã„"></textarea>
            </div>

            <div class="card">
                <h2>æ˜æ—¥ã¸ã®èª²é¡Œ [cite: 5]</h2>
                <textarea id="tomorrowTasks" class="form-control" placeholder="æ¬¡å›ã®å®Ÿç¿’ã«å‘ã‘ãŸèª²é¡Œã‚’è¨˜å…¥ã—ã¦ãã ã•ã„"></textarea>
            </div>

            <div class="card">
                <h2>å®Ÿç¿’æŒ‡å°è€…ã‹ã‚‰ã®ã‚³ãƒ¡ãƒ³ãƒˆ [cite: 5]</h2>
                <textarea id="instructorComment" class="form-control" placeholder="ï¼ˆæŒ‡å°è€…è¨˜å…¥æ¬„ï¼‰"></textarea>
            </div>

            <div style="position: sticky; bottom: 20px;">
                <button type="submit" id="saveBtn" class="btn btn-primary" style="width:100%; font-size:22px; box-shadow: 0 4px 15px rgba(0,86,179,0.3);">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜ãƒ»è¿½è¨˜ã™ã‚‹</button>
            </div>
        </form>
    </div>
</div>

<script>
    // â˜…é‡è¦: GASã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªURLã«å·®ã—æ›¿ãˆã¦ãã ã•ã„
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwpn64ngRPODcpLmi8oww1b9JEWdcZK4gSckL9Ved0A0TDfGtMV1NV1YvYcdRKIo2HTqg/exec"; 
    let currentUser = { id: "", name: "" };

    async function login() {
        const studentId = document.getElementById('studentId').value;
        const password = document.getElementById('password').value;
        const errDiv = document.getElementById('loginError');
        
        try {
            const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "login", studentId, password })});
            const result = await res.json();
            if (result.success) {
                currentUser = { id: studentId, name: result.userName };
                document.getElementById('userNameDisp').innerText = result.userName;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                refreshDateList();
            } else {
                errDiv.classList.remove('hidden');
            }
        } catch (e) { alert("æ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚GASã®URLã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"); }
    }

    async function refreshDateList() {
        const listDiv = document.getElementById('dateList');
        const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "getList", studentId: currentUser.id })});
        const result = await res.json();
        
        if (result.dates && result.dates.length > 0) {
            listDiv.innerHTML = result.dates.map(date => 
                `<div class="date-item" onclick="loadSpecificDate('${date}')"><span>ğŸ“… ${date}</span> <b>ç·¨é›† ></b></div>`
            ).join('');
        } else {
            listDiv.innerHTML = "<p style='padding:15px;'>ä¿å­˜ã•ã‚ŒãŸæ—¥èªŒã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
        }
    }

    function createNewEntry() {
        const date = document.getElementById('newDate').value;
        if(!date) return alert("æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„");
        document.getElementById('journalForm').reset();
        document.getElementById('practiceDate').value = date;
        document.getElementById('activityBody').innerHTML = "";
        addActivityRow();
        document.getElementById('journalForm').classList.remove('hidden');
        document.getElementById('journalForm').scrollIntoView({behavior: "smooth"});
    }

    async function loadSpecificDate(date) {
        const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "load", studentId: currentUser.id, date })});
        const result = await res.json();
        if (result.success) {
            const d = result.data;
            document.getElementById('journalForm').classList.remove('hidden');
            document.getElementById('practiceDay').value = d[3];
            document.getElementById('practiceDate').value = date;
            document.getElementById('attendanceTime').value = d[5];
            document.getElementById('exitTime').value = d[6];
            document.getElementById('learningGoals').value = d[7];
            
            // æ´»å‹•è¨˜éŒ²ã®å¾©å…ƒ
            const body = document.getElementById('activityBody');
            body.innerHTML = "";
            const activities = JSON.parse(d[8]);
            if(activities.length > 0) {
                activities.forEach(a => addActivityRow(a.start, a.end, a.schedule, a.action));
            } else { addActivityRow(); }

            document.getElementById('reflection').value = d[9];
            document.getElementById('tomorrowTasks').value = d[10];
            document.getElementById('instructorComment').value = d[11];
            document.getElementById('journalForm').scrollIntoView({behavior: "smooth"});
        }
    }

    function addActivityRow(start="", end="", schedule="", action="") {
        const rowId = Date.now() + Math.random();
        const row = `<tr id="row_${rowId}">
            <td>
                <div class="time-select-group">
                    <input type="time" class="act-start" value="${start}">
                    <span>ï½</span>
                    <input type="time" class="act-end" value="${end}">
                </div>
            </td>
            <td><input type="text" class="form-control act-sched" value="${schedule}" placeholder="ä¾‹: ã‚ªãƒªã‚¨ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³"></td>
            <td><textarea class="form-control act-action" style="min-height:60px;">${action}</textarea></td>
            <td style="text-align:center;"><button type="button" onclick="document.getElementById('row_${rowId}').remove()" style="color:red; background:none; border:none; font-size:20px; cursor:pointer;">Ã—</button></td>
        </tr>`;
        document.getElementById('activityBody').insertAdjacentHTML('beforeend', row);
    }

    document.getElementById('journalForm').onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById('saveBtn');
        btn.innerText = "ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸é€ä¿¡ä¸­...";
        btn.disabled = true;

        const activities = Array.from(document.querySelectorAll('#activityBody tr')).map(tr => ({
            start: tr.querySelector('.act-start').value,
            end: tr.querySelector('.act-end').value,
            schedule: tr.querySelector('.act-sched').value,
            action: tr.querySelector('.act-action').value
        }));

        const data = {
            action: "save",
            studentId: currentUser.id,
            studentName: currentUser.name,
            practiceDay: document.getElementById('practiceDay').value,
            practiceDate: document.getElementById('practiceDate').value,
            attendanceTime: document.getElementById('attendanceTime').value,
            exitTime: document.getElementById('exitTime').value,
            learningGoals: document.getElementById('learningGoals').value,
            activities: activities,
            reflection: document.getElementById('reflection').value,
            tomorrowTasks: document.getElementById('tomorrowTasks').value,
            instructorComment: document.getElementById('instructorComment').value
        };

        try {
            await fetch(GAS_URL, { method: "POST", body: JSON.stringify(data) });
            alert("ä¿å­˜ãŒå®Œäº†ã—ã¾ã—ãŸï¼");
            refreshDateList();
        } catch (err) {
            alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        } finally {
            btn.innerText = "ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜ãƒ»è¿½è¨˜ã™ã‚‹";
            btn.disabled = false;
        }
    };
</script>

</body>
</html>
