<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>実習日誌システム</title>
    <style>
        body { font-family: sans-serif; background: #f4f7f6; padding: 20px; }
        .card { background: white; padding: 25px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .form-control { width: 100%; padding: 15px; font-size: 16px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; margin-top: 5px; }
        textarea.form-control { min-height: 120px; line-height: 1.5; }
        .reflection-area { min-height: 300px !important; } /* 振り返り欄を特に大きく */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .btn { padding: 12px 24px; cursor: pointer; border-radius: 4px; border: none; font-weight: bold; }
        .btn-primary { background: #007bff; color: white; }
        .btn-load { background: #28a745; color: white; }
        .hidden { display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ccc; padding: 10px; }
    </style>
</head>
<body>

    <div id="loginScreen" class="card" style="max-width: 400px; margin: 100px auto;">
        <h2>学生ログイン</h2>
        <input type="text" id="studentId" class="form-control" placeholder="学籍番号"><br>
        <input type="password" id="password" class="form-control" placeholder="パスワード"><br>
        <button onclick="login()" class="btn btn-primary" style="width:100%">ログイン</button>
    </div>

    <div id="mainApp" class="hidden">
        <header class="card" style="display:flex; justify-content: space-between; align-items: center;">
            <h1 style="margin:0;">実習日誌</h1>
            <div>
                <span id="userNameDisp"></span> さん
                <button onclick="location.reload()" class="btn">ログアウト</button>
            </div>
        </header>

        <div class="card">
            <h3>作成・追記する日を選択</h3>
            <div class="grid">
                <input type="date" id="targetDate" class="form-control">
                <button onclick="loadEntry()" class="btn btn-load">この日のデータを読み込む / 新規作成</button>
            </div>
        </div>

        <form id="journalForm" class="hidden">
            <div class="card">
                <div class="grid">
                    <div><label>実習日目</label><input type="number" id="practiceDay" class="form-control" required></div>
                    <div><label>年月日</label><input type="date" id="practiceDate" class="form-control" readonly></div>
                </div>
                <div class="grid" style="margin-top:15px;">
                    <div><label>出席時間</label><input type="time" id="attendanceTime" class="form-control"></div>
                    <div><label>退出時間</label><input type="time" id="exitTime" class="form-control"></div>
                </div>
            </div>

            <div class="card">
                <label>本日の学習目標</label>
                <textarea id="learningGoals" class="form-control"></textarea>
            </div>

            <div class="card">
                <label>活動記録 (時間・日程・行動)</label>
                <table id="activityTable">
                    <thead><tr><th>時間</th><th>日程</th><th>行動</th></tr></thead>
                    <tbody id="activityBody">
                        </tbody>
                </table>
                <button type="button" onclick="addActivityRow()" class="btn" style="margin-top:10px;">＋行を追加</button>
            </div>

            <div class="card">
                <label>今日一日を振り返って</label>
                <textarea id="reflection" class="form-control reflection-area" placeholder="印象に残った学び、考えたこと、感じたこと"></textarea>
            </div>

            <div class="card">
                <label>明日への課題</label>
                <textarea id="tomorrowTasks" class="form-control"></textarea>
            </div>

            <div class="card">
                <label>実習指導者からのコメント</label>
                <textarea id="instructorComment" class="form-control"></textarea>
            </div>

            <button type="submit" class="btn btn-primary" style="width:100%; font-size:18px;">スプレッドシートに保存</button>
        </form>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbwpn64ngRPODcpLmi8oww1b9JEWdcZK4gSckL9Ved0A0TDfGtMV1NV1YvYcdRKIo2HTqg/exec";
        let user = { id: "", name: "" };

        async function login() {
            const studentId = document.getElementById('studentId').value;
            const password = document.getElementById('password').value;
            const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "login", studentId, password })});
            const result = await res.json();
            if (result.success) {
                user = { id: studentId, name: result.userName };
                document.getElementById('userNameDisp').innerText = result.userName;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
            } else { alert("ログイン失敗"); }
        }

        async function loadEntry() {
            const date = document.getElementById('targetDate').value;
            if(!date) return alert("日付を選択してください");
            
            const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "load", studentId: user.id, date })});
            const result = await res.json();
            
            document.getElementById('journalForm').classList.remove('hidden');
            document.getElementById('practiceDate').value = date;
            
            if (result.success) {
                const d = result.data;
                document.getElementById('practiceDay').value = d[3];
                document.getElementById('attendanceTime').value = d[5];
                document.getElementById('exitTime').value = d[6];
                document.getElementById('learningGoals').value = d[7];
                renderActivities(JSON.parse(d[8]));
                document.getElementById('reflection').value = d[9];
                document.getElementById('tomorrowTasks').value = d[10];
                document.getElementById('instructorComment').value = d[11];
                alert("過去のデータを読み込みました。追記して保存できます。");
            } else {
                document.getElementById('journalForm').reset();
                document.getElementById('practiceDate').value = date;
                document.getElementById('activityBody').innerHTML = "";
                addActivityRow();
                alert("新規作成として開始します。");
            }
        }

        function addActivityRow(time="", schedule="", action="") {
            const row = `<tr>
                <td><input type="text" class="form-control act-time" value="${time}"></td>
                <td><input type="text" class="form-control act-sched" value="${schedule}"></td>
                <td><input type="text" class="form-control act-action" value="${action}"></td>
            </tr>`;
            document.getElementById('activityBody').insertAdjacentHTML('beforeend', row);
        }

        function renderActivities(list) {
            document.getElementById('activityBody').innerHTML = "";
            list.forEach(a => addActivityRow(a.time, a.schedule, a.action));
        }

        document.getElementById('journalForm').onsubmit = async (e) => {
            e.preventDefault();
            const activities = Array.from(document.querySelectorAll('#activityBody tr')).map(tr => ({
                time: tr.querySelector('.act-time').value,
                schedule: tr.querySelector('.act-sched').value,
                action: tr.querySelector('.act-action').value
            }));

            const data = {
                action: "save",
                studentId: user.id,
                studentName: user.name,
                practiceDay: document.getElementById('practiceDay').value,
                practiceDate: document.getElementById('practiceDate').value,
                attendanceTime: document.getElementById('attendanceTime').value,
                exitTime: document.getElementById('exitTime').value,
                learningGoals: document.getElementById('learningGoals').value,
                activities: activities,
                reflection: document.getElementById('reflection').value,
                tomorrowTasks: document.getElementById('tomorrowTasks').value,
                instructorComment: document.getElementById('instructorComment').value
            };

            await fetch(GAS_URL, { method: "POST", body: JSON.stringify(data) });
            alert("保存が完了しました。");
        };
    </script>
</body>
</html>
